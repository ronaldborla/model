(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports):typeof define==="function"&&define.amd?define(["exports"],factory):factory(global.window=global.window||{})})(this,function(exports){"use strict";function __extends(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}var __="__private__";var Utils=function(){function Utils(){this.undefined=function(undefined){return undefined}()}Utils.prototype.camelCase=function(str){return str.replace(/[-_]+/g," ").replace(/(?:^\w|[A-Z]|\b\w|[\s-_]+)/g,function(match,index){if(+match===0){return""}return index===0?match.toLowerCase():match.toUpperCase()})};Utils.prototype.emit=function(){var utils=this;return function(name,args,source){if(utils.isUndefined(source)){source=this}this.fire(name,args,source);if(!utils.isUndefined(this[__].parent)&&utils.isFunction(this[__].parent.emit)){this[__].parent.emit(name,args,source)}if(!utils.isUndefined(this[__].collection)&&utils.isFunction(this[__].collection.emit)){this[__].collection.emit(name,args,source)}return this}};Utils.prototype.extend=function(left,right,ignore){var _this=this;this.forEach(right,function(value,name){if(_this.isUndefined(ignore)||ignore.indexOf(name)<0){left[name]=value}});return left};Utils.prototype.fire=function(){var utils=this;return function(name,args,source){var _this=this;if(!utils.isUndefined((this[__].listeners||{})[name])){var e={name:name,source:utils.isUndefined(source)?this:source};args=(args||[]).slice();args.unshift(e);(this[__].listeners[name]||[]).forEach(function(callback){callback.apply(_this,args||[])})}return this}};Utils.prototype.flattenIgnore=function(ignore){var _this=this;var flattened={__flattened:true};if(!this.isUndefined(ignore)){var child_keys_1=[];(ignore||[]).forEach(function(attribute){var pos=attribute.indexOf("."),left=pos>=0?attribute.substr(0,pos):attribute,right=pos>=0?attribute.substr(pos+1):"";if(right){if(_this.isUndefined(flattened[left])){flattened[left]=[]}if(flattened[left]!==true){if(child_keys_1.indexOf(left)<0){child_keys_1.push(left)}flattened[left].push(right)}}else{flattened[left]=true}});child_keys_1.forEach(function(key){if(flattened[key]!==true){flattened[key]=_this.flattenIgnore(flattened[key])}})}return flattened};Utils.prototype.forEach=function(object,callback){for(var o in object){if(object.hasOwnProperty(o)){if(callback.apply(object,[object[o],o,object])===false){return false}}}return true};Utils.prototype.inherit=function(parent,child,ignore){child.prototype=Object.create(parent.prototype);child.prototype.constructor=child;this.extend(child,parent,ignore);return child};Utils.prototype.isFunction=function(variable){return!!(variable&&variable.constructor&&variable.call&&variable.apply)};Utils.prototype.isUndefined=function(variable){return variable===this.undefined};Utils.prototype.on=function(){var utils=this;return function(name,callback){var object=this;if(!utils.isFunction(callback)){throw new Error("Callback parameter must be a function")}if(utils.isUndefined(this[__].listeners)){this[__].listeners={}}if(utils.isUndefined(this[__].listeners[name])){this[__].listeners[name]=[];this[__].listeners[name].__index=0}var id=callback.id=this[__].listeners[name].__index++;this[__].listeners[name].push(callback);return function(){var index=-1,length=object[__].listeners[name].length;for(var i=0;i<length;i++){if(object[__].listeners[name][i].id===id){index=i;break}}if(index>=0){object[__].listeners[name].splice(index,1)}return object}}};return Utils}();var utils=new Utils;var Model=function(){function Model(){this[__]={attributes:{},listeners:{}};this.constructor.schema.applyDefaults(this)}Model.prototype.emit=function(name,args,source){return utils.emit().apply(this,[name,args,source])};Model.prototype.fire=function(name,args,source){return utils.fire().apply(this,[name,args,source])};Model.prototype.load=function(data){var _this=this;utils.forEach(data||{},function(value,key){if(_this.constructor.schema.hasKey(key)||_this.constructor.schema.hasVirtual(key,"set")){_this[key]=value}});return this.fire("load")};Model.prototype.on=function(name,callback){return utils.on().apply(this,[name,callback])};Model.prototype.toJSON=function(ignore,replacer,space){return JSON.stringify(this.toObject(ignore),replacer,space)};Model.prototype.toObject=function(ignore){var _this=this;var object={},schema=this.constructor.schema;if(!ignore||!ignore.__flattened){ignore=utils.flattenIgnore(ignore)}schema.all_keys.forEach(function(key){if(ignore[key.name]!==true){var value=_this[key.name];if(value&&utils.isFunction(value.toObject)){value=value.toObject(ignore[key.name])}if(!utils.isUndefined(value)){object[key.name]=value}}});if((schema.options.toObject||{}).virtuals===true){schema.virtuals.__keys.forEach(function(key_name){if(ignore[key_name]!==true&&(utils.isFunction(schema.virtuals[key_name].get)||utils.isFunction(schema.virtuals[key_name]))){var value=_this[key_name];if(value&&utils.isFunction(value.toObject)){value=value.toObject(ignore[key_name])}if(!utils.isUndefined(value)){object[key_name]=value}}})}return object};Model.prototype.toString=function(){return this.toJSON()};return Model}();var Collection=function(_super){__extends(Collection,_super);function Collection(){var _this=this;_this[__]={attributes:{},listeners:{}};_this.constructor.schema.applyDefaults(_this);return _this}Collection.prototype.cast=function(variable){var item=this.type.cast(variable);if(item instanceof Model){item[__].collection=this}return item};Object.defineProperty(Collection.prototype,"model",{get:function(){return utils.model.models[this.constructor.__constructor]||Model},enumerable:true,configurable:true});Object.defineProperty(Collection.prototype,"type",{get:function(){return utils.model.types[this.constructor.__constructor||"Model"]},enumerable:true,configurable:true});Collection.prototype.concat=function(){for(var i=0;i<arguments.length;i++){this.push.apply(this,arguments[i])}return this};Collection.prototype.emit=function(name,args,source){return utils.emit().apply(this,[name,args,source])};Collection.prototype.fill=function(){arguments[0]=this.cast(arguments[0]);return Array.prototype.fill.apply(this,arguments)};Collection.prototype.fire=function(name,args,source){return utils.fire().apply(this,[name,args,source])};Collection.prototype.load=function(items){this.push.apply(this,items||[]);return this.fire("load")};Collection.prototype.on=function(name,callback){return utils.on().apply(this,[name,callback])};Collection.prototype.push=function(){for(var i=0;i<arguments.length;i++){arguments[i]=this.cast(arguments[i])}return Array.prototype.push.apply(this,arguments)};Collection.prototype.splice=function(){if(arguments.length>2){for(var i=2;i<arguments.length;i++){arguments[i]=this.cast(arguments[i])}}return Array.prototype.splice.apply(this,arguments)};Collection.prototype.toJSON=function(ignore,replacer,space){return JSON.stringify(this.toObject(ignore),replacer,space)};Collection.prototype.toObject=function(ignore){if(!ignore||!ignore.__flattened){ignore=utils.flattenIgnore(ignore)}return this.map(function(item){return utils.isFunction(item.toObject)?item.toObject(ignore):item})};Collection.prototype.toString=function(){return this.toJSON()};Collection.prototype.unshift=function(){for(var i=0;i<arguments.length;i++){arguments[i]=this.cast(arguments[i])}return Array.prototype.unshift.apply(this,arguments)};return Collection}(Array);var Type=function(){function Type(name,constructor){this.name=null;this.safe=null;this.__constructor=null;this.name=name+"";this.safe=this.name.toLowerCase();constructor.type=this;this.__constructor=constructor;this.has_compare=utils.isFunction(this.__constructor.prototype.compare)}Type.prototype.cast=function(variable,options){if(!this.is(variable)){variable=new this.__constructor(variable,options)}return variable};Type.prototype.compare=function(a,b){if(this.has_compare){return a.compare(b)}if(a>b){return 1}else if(b>a){return-1}else{return 0}};Type.prototype.is=function(variable){return(typeof variable).toLowerCase()===this.safe||variable&&variable instanceof this.__constructor};Type.prototype.match=function(constructor){return constructor===this.__constructor};return Type}();var Key=function(){function Key(schema,name,key){this["default"]=utils.undefined;this.name=null;this.options=utils.undefined;this.schema=null;this.type=null;this.booted=false;this.schema=schema;this.name=name;this["default"]=key["default"];this.options=key.options;this.type=key.type||key}Key.prototype.boot=function(){if(this.booted){return this}var key=this,name=this.name,schema=this.schema;if(!(this.type instanceof Type)){this.type=schema.model.type(this.type)}Object.defineProperty(schema.__constructor.prototype,name,{get:function(){return callMutator.apply(this,["get",this[__].attributes[name]])},set:function(value){var previous=this[__].attributes[name];value=setParent(key.type.cast(value,key.options),this);this[__].attributes[name]=value=callMutator.apply(this,["set",value]);return this.fire("setAttribute",[name,value,previous])}});this.booted=true;return this;function callMutator(method,value){var mutator=schema.cache.mutators[method][name];if(utils.isUndefined(mutator)){var fn=utils.camelCase([method,name,"attribute"].join(" "));mutator=schema.cache.mutators[method][name]=utils.isFunction(this[fn])?fn:null}if(mutator!==null){value=this[mutator].apply(this,[value])}return value}function setParent(value,model){if(value&&(value instanceof Model||value instanceof Collection)){value[__].parent=model}return value}};Key.Type=Type;return Key}();var Schema=function(){function Schema(constructor,keys,options){var _this=this;this.keys=[];this.methods={};this.statics={};this.virtuals={};this.booted=false;this.model=null;this.options={};this.type="model";this.cache={mutators:{get:{},set:{}}};constructor.schema=this;this.__constructor=constructor;this.options=options||{};if(!utils.isUndefined(keys)&&keys){var index_1=0;this.keys.__index={};utils.forEach(keys,function(key,name){var key_instance=new Key(_this,name,key);_this.keys.__index[key_instance.name]=index_1++;_this.keys.push(key_instance)})}}Object.defineProperty(Schema.prototype,"all_keys",{get:function(){var _this=this;if(!utils.isUndefined(this.__keys)){return this.__keys}this.__keys=[].concat(this.inherited_keys,this.keys);this.__keys.__index={};this.__keys.forEach(function(key,i){_this.__keys.__index[key.name]=i});return this.__keys},enumerable:true,configurable:true});Object.defineProperty(Schema.prototype,"base_constructor",{get:function(){switch(this.type){case"collection":return Collection;case"model":return Model}return utils.undefined},enumerable:true,configurable:true});Object.defineProperty(Schema.prototype,"constructors",{get:function(){return this.model.schemas[this.type+"s"]},enumerable:true,configurable:true});Object.defineProperty(Schema.prototype,"inherited_keys",{get:function(){var schema=(this.__constructor.inherits||{}).schema||{},parent_keys=schema.keys||[],keys=[];(schema.inherited_keys||[]).forEach(function(key){if(utils.isUndefined(parent_keys.__index[key.name])){keys.push(key)}});return keys.concat(parent_keys)},enumerable:true,configurable:true});Schema.prototype.applyDefaults=function(object){this.all_keys.forEach(function(key){if(!utils.isUndefined(key["default"])){object[key.name]=key["default"]}});return object};Schema.prototype.boot=function(){var _this=this;if(this.booted){return this}if(utils.isUndefined(this.__constructor.inherits)){this.__constructor.inherits=this.base_constructor;if(utils.isUndefined(this.__constructor.inherits)){throw new Error("Invalid schema type: "+this.type)}}if(!utils.isFunction(this.__constructor.inherits)){var parent=this.constructors[this.__constructor.inherits];if(utils.isUndefined(parent)){throw new Error("Invalid schema type: "+this.type)}this.__constructor.inherits=parent instanceof Schema?parent.boot().__constructor:parent}utils.inherit(this.__constructor.inherits,this.__constructor,["__constructor","__name","inherits","schema","type"]);utils.forEach(this.methods,function(value,key,object){if(utils.isFunction(value)){_this.__constructor.prototype[key]=value}});utils.forEach(this.statics,function(value,key,object){_this.__constructor[key]=value});this.virtuals.__keys=[];utils.forEach(this.virtuals,function(virtual,key){var definition={};if(utils.isFunction(virtual)){definition.get=virtual}else{if(!virtual){virtual={}}if(utils.isFunction(virtual.get)){definition.get=virtual.get}if(utils.isFunction(virtual.set)){definition.set=virtual.set}}if(utils.isFunction(definition.get)||utils.isFunction(definition.set)){Object.defineProperty(_this.__constructor.prototype,key,definition)}_this.virtuals.__keys.push(key)});this.booted=true;return this};Schema.prototype.define=function(modeljs,name,type,model){this.__constructor.__name=name;this.model=modeljs;if(!utils.isUndefined(type)){this.type=type}if(this.type==="collection"){this.__constructor.__constructor=model||"Model"}return this};Schema.prototype.hasKey=function(name){return!utils.isUndefined(this.getKey(name))};Schema.prototype.hasVirtual=function(name,method){if(method===void 0){method="get"}if(method==="get"){return utils.isFunction(this.virtuals[name])||utils.isFunction(this.virtuals[name].get)}else if(method==="set"){return!utils.isUndefined(this.virtuals[name])&&utils.isFunction(this.virtuals[name].set)}else{return false}};Schema.prototype.inherit=function(parent){this.__constructor.inherits=parent;return this};Schema.prototype.getKey=function(name){return this.all_keys[this.all_keys.__index[name]]};Schema.prototype.method=function(name,callback){this.methods[name]=callback;return this};Schema.prototype.static=function(name,callback){this.statics[name]=callback;return this};Schema.prototype["super"]=function(object,name,args){if(name==="constructor"){return this.__constructor.inherits.apply(object,args||[])}else{return this.__constructor.inherits.prototype[name].apply(object,args||[])}};Schema.prototype.virtual=function(name,callback,method){if(method===void 0){method="get"}if(method!=="get"&&method!=="set"){throw new Error("Invalid virtual method: "+method)}if(utils.isUndefined(this.virtuals[name])){this.virtuals[name]={}}else if(utils.isFunction(this.virtuals[name])){this.virtuals[name]={get:this.virtuals[name]}}this.virtuals[name][method]=callback;return this};Schema.Key=Key;return Schema}();var ModelJS=function(){function ModelJS(){this.Collection=Collection;this.Model=Model;this.Schema=Schema;this.types={};this.utils=utils;this.booted=false;this.collections={};this.models={};this.schemas={collections:{},models:{}};utils.model=this;this.schemas.collections.__keys=[];this.schemas.models.__keys=[];this.types.__keys=[];this.types.__length=0;this.type("Array",Array);this.type("Boolean",Boolean);this.type("Date",Date);this.type("Number",Number);this.type("Object",Object);this.type("String",String);this.type("Model",Model);this.type("Collection",Collection)}ModelJS.prototype.register=function(type,name,schema,inherit,model){var plural=type+"s";if(utils.isUndefined(schema)){if(!this.booted){throw new Error("modeljs must be booted first")}return this[plural][name]}else{if(!(schema instanceof Schema)){throw new Error("schema must be an instance of `Schema`")}this.schemas[plural][name]=schema.define(this,name,type,model);this.schemas[plural].__keys.push(name);if(!utils.isUndefined(inherit)){this.schemas[plural][name].inherit(inherit)}return this.schemas[plural][name]}};ModelJS.prototype.boot=function(){var _this=this;if(this.booted){return this}this.schemas.models.__keys.forEach(function(name){if(!utils.isUndefined(_this.models[name])){throw new Error("Model already exists: "+name)}_this.models[name]=_this.schemas.models[name].boot().__constructor;_this.type(name,_this.models[name])});this.schemas.models.__keys.forEach(function(name){_this.models[name].schema.keys.forEach(function(key){key.boot()})});this.schemas.collections.__keys.forEach(function(name){if(!utils.isUndefined(_this.collections[name])){throw new Error("Collection already exists: "+name)}_this.collections[name]=_this.schemas.collections[name].boot().__constructor;_this.type(name,_this.collections[name])});this.booted=true;return this};ModelJS.prototype.collection=function(name,schema,model,inherit){return this.register("collection",name,schema,inherit,model)};ModelJS.prototype.model=function(name,schema,inherit){return this.register("model",name,schema,inherit)};ModelJS.prototype.type=function(name,constructor){if(utils.isUndefined(constructor)){if(utils.isFunction(name)){for(var i=0;i<this.types.__length;i++){var type=this.types[this.types.__keys[i]];if(type.match(name)){return type}}}if(utils.isUndefined(this.types[name])){throw new Error("Type `"+name+"` does not exist")}return this.types[name]}else{if(!utils.isUndefined(this.types[name])){throw new Error("Type `"+name+"` already exists")}this.types[name]=new Type(name,constructor);this.types.__keys.push(name);this.types.__length++;return this}};return ModelJS}();var modeljs=new ModelJS;exports.modeljs=modeljs;Object.defineProperty(exports,"__esModule",{value:true})});