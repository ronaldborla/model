window.Model=function(window,undefined){"use strict";var Model=function(schema,define){var Constructor=null,methods={},virtuals={},statics={},options={},utils=Model.utils,$=utils.$,attr=function(self){return $(self).attributes},construct=function(self,args){return $(self).attributes={},$(self).listeners={},self.schema.forEach(function(key){key.hasDefault()&&(self[key.name]=key.getDefault(self))}),self};return methods.get=function(name){var method=utils.camelCase(["get",name,"attribute"].join(" ")),orig=attr(this)[name];return utils.isFunction(this[method])?this[method].apply(this,[orig]):orig},methods.set=function(name,value){var key=this.schema.get(name),attributes=attr(this),previous=attributes[name],method=utils.camelCase(["set",name,"attribute"].join(" ")),evaluated=key.evaluate(value,this);return utils.isFunction(this[method])?attributes[name]=this[method].apply(this,[evaluated,previous]):attributes[name]=evaluated,attributes[name]&&"object"==typeof attributes[name]&&(utils.$(attributes[name]).parent=this),this.fire("setAttribute",[name,attributes[name],previous]),this.fire(method,[attributes[name],previous]),utils.typeCompare(key.type,attributes[name],previous)&&this.change(),this},methods.define=utils.define,methods.on=utils.on,methods.fire=utils.fire,methods.emit=utils.emit,methods.change=utils.change,methods["throw"]=utils["throw"],methods.load=function(data){var self=this;return data=this.filter("load",data),utils.isDefined(data)&&(this.fire("beforeload",[data]),this.schema.forEach(function(key){utils.isDefined(data[key.name])&&(self[key.name]=data[key.name])}),this.fire("load")),this},methods.filter=function(name,data){return data},methods.toObject=function(exclude){var self=this,object={};utils.isDefined(exclude)?(utils.is("String",exclude)&&(exclude=[exclude]),utils.is("Array",exclude)&&(exclude=utils.arrayOfStringsToObject(exclude))):exclude={},utils.is("Object",exclude)||this["throw"]("`exclude` must be an object or an array of strings");var registerValue=function(key){var keyName=key.name||key;if(exclude[keyName]!==!0){var exportMethod=utils.camelCase(["export",keyName,"attribute"].join(" ")),value=utils.isFunction(self[exportMethod])?self[exportMethod].apply(self,[self[keyName]]):self[keyName],hasToObject=value&&utils.isFunction(value.toObject);hasToObject||!utils.is("Object",value)||utils.is("Array",value)||(value=utils.is("Date",value)?value.toString():utils.cleanObject(value)),object[keyName]=hasToObject?value.toObject(exclude[keyName]):value}};return this.schema.forEach(registerValue),this.schema.options&&this.schema.options["export"]&&this.schema.options["export"].virtuals&&this.schema.virtuals.forEach(registerValue),object=this.filter("export",object),this.fire("export",[object,exclude]),object},methods.toJson=function(exclude,replacer,space){return JSON.stringify(this.toObject(exclude),replacer,space)},statics.isModel=!0,statics.inherit=function(extendSchema,defineModel){var parentSchema=this.prototype.schema,childSchema=parentSchema["export"](extendSchema),methods={},virtuals={},statics={},options=utils.clone(parentSchema.options||{});return utils.inherit(parentSchema.Constructor,function(construct){return defineModel(construct,methods,virtuals,statics,options)},function(proto,Constructor){return proto.schema=new Model.Schema(Constructor,childSchema,parentSchema,utils.keys(virtuals||{}),options),utils.extendConstructor(Constructor,methods,virtuals,statics)})},utils.isFunction(define)&&(Constructor=define(construct,methods,virtuals,statics,options)),utils.isFunction(Constructor)||(Constructor=function(data){construct(this).load(data)}),Constructor.prototype.schema=new Model.Schema(Constructor,schema,null,utils.keys(virtuals||{}),options),utils.extendConstructor(Constructor,methods,virtuals,statics)};return Model}(window),function(window,Model,undefined){"use strict";var utils={};utils.sign="__local__",utils.typeOrder=["Boolean","Number","String","Date","Array","Model","Collection","Object"],utils.isDefined=function(variable){return variable!==undefined},utils.isUndefined=function(variable){return!utils.isDefined(variable)},utils.isFunction=function(object){return!!(object&&object.constructor&&object.call&&object.apply)},utils.is=function(type,value){return type=type.name||type,Model.Schema.Types[type]&&Model.Schema.Types[type].is(value)},utils.inherits=function(type,Constructor){return type=type.name||type,Model.Schema.Types[type]&&Model.Schema.Types[type].inherits(Constructor)},utils.sort=function(array,descending){return array.sort(function(a,b){return descending?b-a:a-b}),array},utils.keys=function(object,sort){var keys=window.Object.keys(object);return"undefined"!=typeof sort&&utils.sort(keys,!sort),keys},utils.type=function(value){for(var i=0;i<utils.typeOrder.length;i++){var type=Model.Schema.Types[utils.typeOrder[i]];if(type.is(value))return type}return Model.Schema.Types.Any},utils.compare=function(a,b,deep,level){var aType=utils.type(a),bType=utils.type(b);return aType.name!==bType.name?!0:utils.typeCompare(aType,a,b,deep,level)},utils.typeCompare=function(type,a,b,deep,level){return type.is(a)&&type.is(b)?type.compare(a,b,deep,level):!0},utils.forEach=function(object,callback){for(var o in object)if(object.hasOwnProperty(o)&&callback.apply(object,[object[o],o,object])===!1)return!1;return!0},utils.clone=function(object){return JSON.parse(JSON.stringify(object))},utils.extend=function(left,right){return utils.forEach(right,function(value,name){left[name]=value}),left},utils.ucfirst=function(string){return string[0].toUpperCase()+string.substr(1)},utils.camelCase=function(str){return str.replace(/[-_]+/g," ").replace(/(?:^\w|[A-Z]|\b\w|[\s-_]+)/g,function(match,index){return 0===+match?"":0===index?match.toLowerCase():match.toUpperCase()})},utils.arrayOfStringsToObject=function(strings){var object={};return utils.is("Array",strings)&&strings.forEach(function(string){var arr=string.split("."),name=arr[0],child=arr.length>1?arr.splice(1).join("."):"";utils.isUndefined(object[name])&&(object[name]=[]),child&&object[name]!==!0?object[name].push(child):object[name]=!0}),utils.keys(object).forEach(function(key){utils.is("Array",object[key])&&(object[key]=utils.arrayOfStringsToObject(object[key]))}),object},utils.cleanObject=function(dirty){var object={};return utils.forEach(dirty,function(value,key){key!==utils.sign&&(object[key]=value)}),object},utils.inherit=function(Parent,getConstructor,definePrototype){var construct=function(child,args){return Parent.apply(child,args||[]),child},Constructor=getConstructor(construct);return Constructor.prototype=window.Object.create(Parent.prototype),Constructor.prototype.constructor=Constructor,utils.extend(Constructor,Parent),utils.isFunction(definePrototype)&&definePrototype(Constructor.prototype,Constructor),Constructor},utils.extendConstructor=function(Constructor,methods,virtuals,statics){var proto=Constructor.prototype;return methods=methods||{},virtuals=virtuals||{},statics=statics||{},utils.extend(proto,methods),utils.forEach(virtuals,function(method,name){utils.define.apply(proto,[name,{get:method}])}),utils.extend(Constructor,statics),Constructor},utils.hasSign=function(self){return utils.isDefined(self[utils.sign])},utils.$=function(self){return utils.hasSign(self)||(self[utils.sign]={}),self[utils.sign]},utils.events=function(self){return utils.isUndefined(utils.$(self).listeners)&&(utils.$(self).listeners={}),utils.$(self).listeners},utils.define=function(name,definition){return window.Object.defineProperty(this,name,definition),this},utils.on=function(event,callback){var listeners=utils.events(this);return utils.is("Array",listeners[event])||(listeners[event]=[],listeners[event].count=0),utils.isFunction(callback)&&(callback.index=listeners[event].count,listeners[event].push(callback),listeners[event].count++),function(){for(var i=0;i<listeners[event].length;i++)if(listeners[event][i].index===callback.index){listeners[event].splice(i,1);break}}},utils.fire=function(event,args){var self=this,listeners=utils.events(this);return utils.is("Array",listeners[event])&&listeners[event].forEach(function(listener){listener.apply(self,args||[])}),this},utils.emit=function(event,args){var parent=this,sourceStack=[this];utils.is("Array",args)||(args=[]);args.length;for(args.push(sourceStack);;){if(parent.fire(event,[args]),!utils.isDefined(utils.$(parent).parent)||!utils.isFunction(utils.$(parent).parent.fire))break;parent=utils.$(parent).parent,sourceStack.push(parent)}return this},utils.change=function(){this.emit("change")},utils["throw"]=function(message){Model.Exception.prototype["throw"].apply(this,[message])},Model.utils=utils}(window,window.Model),function(window,Model,utils,undefined){"use strict";var Collection=function(ModelConstructor,define){utils.inherits("Model",ModelConstructor)||utils["throw"]("Constructor must inherit the Model constructor");var Constructor=null,methods={},virtuals={},statics={},Arr=window.Array.prototype,call=function(method,array,args){return Arr[method].call(array,args||[])},apply=function(method,array,args){return Arr[method].apply(array,args||[])},$=utils.$,construct=function(self){return $(self).listeners={},self};return methods.define=utils.define,methods.on=utils.on,methods.fire=utils.fire,methods.emit=utils.emit,methods.change=utils.change,methods["throw"]=utils["throw"],utils.isFunction(define)&&(Constructor=define(construct,methods,virtuals,statics)),utils.isFunction(Constructor)||(Constructor=function(data){construct(this).load(data)}),statics.isCollection=!0,utils.inherit(window.Array,function(){return Constructor},function(proto,Collection){return proto.Model=ModelConstructor,proto.convert=function(item){return item instanceof this.Model||(item=new this.Model(item)),utils.$(item).parent=this,item},proto.load=function(items){return this.length=0,this.push.apply(this,items),this},proto.push=function(){var self=this;return apply("push",this,call("slice",arguments||{}).map(function(arg){return self.convert(arg)}))},proto.fill=function(){return utils.isDefined(arguments[0])&&(arguments[0]=this.convert(arguments[0])),apply("fill",this,arguments)},proto.splice=function(){var args=call("slice",arguments||{});if(args.length>2)for(var i=2;i<args.length;i++)args[i]=this.convert(args[i]);return apply("splice",this,args)},proto.unshift=function(){var self=this;return apply("unshift",this,call("slice",arguments||{}).map(function(arg){return self.convert(arg)}))},proto.toObject=function(exclude){return this.map(function(item){return item.toObject(exclude)})},proto.toJson=function(exclude,replacer,space){return JSON.stringify(this.toObject(exclude),replacer,space)},utils.extendConstructor(Collection,methods,virtuals,statics)})};Model.Collection=Collection}(window,window.Model,window.Model.utils),function(window,Model,utils,undefined){"use strict";var Exception=utils.inherit(window.Error,function(construct){return function(message,source){construct(this);this.message=message,this.source=source,this.stack=(new Error).stack}});Exception.prototype["throw"]=function(message){throw new Exception(message,this)},Model.Exception=Exception}(window,window.Model,window.Model.utils),function(window,Model,utils,undefined){"use strict";var Schema=utils.inherit(window.Array,function(construct){return function(Constructor,schema,parent,virtuals,options){var self=construct(this);this.Constructor=Constructor,this.parent=parent||null,this.virtuals=virtuals||[],this.options=options||{},this.parent&&this.parent.virtuals.forEach(function(virtual){self.virtuals.indexOf(virtual)<0&&self.virtuals.push(virtual)}),utils.isDefined(schema)&&utils.forEach(schema,function(definition,name){self.set(name,definition)})}},function(proto,Schema){proto.get=function(name){var index=-1;if(utils.isDefined(this.index)||(this.index={}),utils.isDefined(this.index[name])&&(index=this.index[name]),0>=index)for(var i=0;i<this.length;i++)if(this[i].name===name){this.index[name]=index=i;break}return this[index]},proto.set=function(name,definition){this.push(new Schema.Key(this,name,definition))},proto["export"]=function(extend){var json={};return this.forEach(function(key){json[key.name]=key["export"]()}),utils.extend(json,extend||{})}});Model.Schema=Schema}(window,window.Model,window.Model.utils),function(window,Model,utils,undefined){"use strict";var Type=function(name,Constructor,native){this.name=name,this.raw=(name||"").toLowerCase(),this.Constructor=Constructor||null,this["native"]=!!native,this.original=null};Type.prototype.match=function(check){if(check instanceof(this.prototype||this).constructor)return this.match(check.name);var match="Constructor";return utils.is("String",check)&&(match="name"),this[match]===check},Type.prototype.is=function(value){if(null===value)return!1;var type=(typeof value||"").toLowerCase();return"object"===type&&value instanceof this.Constructor?!0:this.raw===type},Type.prototype.inherits=function(Constructor){return utils.isFunction(Constructor)&&this.Constructor===Constructor},Type.prototype.compare=function(a,b,deep,level){return a-b},Model.Schema.Type=Type,Model.Schema.Types={}}(window,window.Model,window.Model.utils),function(window,Type,Types,utils){"use strict";Types.Any=new Type("Any"),Types.Any.compare=function(a,b,deep,level){return!1},Types.Any.is=function(value){return!0},Types.Any.inherits=function(Constructor){return!1}}(window,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types,utils){"use strict";Types.Array=new Type("Array",window.Array,!0),Types.Array.compare=function(a,b,deep,level){if(a.length!==b.length)return!0;if(deep||!level)for(var i=0;i<a.length;a++){var aItem=a[i],bItem=b[i];if(utils.compare(aItem,bItem,deep,(level||0)+1))return!0}return!1},Types.Array.is=function(value){return value&&(value.constructor===window.Array||value instanceof window.Array)}}(window,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types){"use strict";Types.Boolean=new Type("Boolean",window.Boolean,!0)}(window,window.Model.Schema.Type,window.Model.Schema.Types),function(window,Collection,Type,Types,utils){"use strict";Types.Collection=new Type("Collection"),Types.Collection.compare=function(a,b,deep,level){if(a.constructor!==b.constructor)return!0;if(deep||!level)for(var i=0;i<a.length;i++)if(utils.typeCompare(Types.Model,a[i],b[i],deep,(level||0)+1))return!0;return!1},Types.Collection.is=function(value){return value&&value.prototype&&value.prototype.constructor&&value.prototype.constructor.isCollection},Types.Collection.inherits=function(Constructor){return utils.isFunction(Constructor)&&!!Constructor.isCollection}}(window,window.Model.Collection,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types){"use strict";Types.Date=new Type("Date",window.Date,!0),Types.Date.is=function(value){return value&&(value.constructor===window.Date||value instanceof window.Date)}}(window,window.Model.Schema.Type,window.Model.Schema.Types),function(window,Model,Type,Types,utils){"use strict";Types.Model=new Type("Model"),Types.Model.compare=function(a,b,deep,level){if(a.constructor!==b.constructor)return!0;if(deep||!level)for(var i=0;i<a.schema.length;i++){var key=a.schema[i];if(utils.typeCompare(key.type,a[key.name],b[key.name],deep,(level||0)+1))return!0}return!1},Types.Model.is=function(value){return value&&value.prototype&&value.prototype.constructor&&value.prototype.constructor.isModel},Types.Model.inherits=function(Constructor){return utils.isFunction(Constructor)&&!!Constructor.isModel}}(window,window.Model,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types){"use strict";Types.Number=new Type("Number",window.Number,!0)}(window,window.Model.Schema.Type,window.Model.Schema.Types),function(window,Type,Types,utils){"use strict";Types.Object=new Type("Object",window.Object,!0),Types.Object.compare=function(a,b,deep,level){var aKeys=utils.keys(a,!0),bKeys=utils.keys(b,!0);if(aKeys.length!==bKeys.length)return!0;if(deep||!level)for(var i=0;i<aKeys.length;i++){var aKey=aKeys[i],bKey=bKeys[i];if(aKey!==bKey)return!0;if(utils.compare(aKey,bKey,deep,(level||0)+1))return!0}return!1}}(window,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types,utils){"use strict";Types.Self=new Type("Self"),Types.Self.compare=function(a,b,deep,level){return!1},Types.Self.is=function(value){return!1}}(window,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types){"use strict";Types.String=new Type("String",window.String,!0),Types.String.compare=function(a,b,deep,level){return b>a?-1:a>b?1:0}}(window,window.Model.Schema.Type,window.Model.Schema.Types),function(window,Model,utils,undefined){"use strict";var keyAttributes=["enum"],Key=function(schema,name,definition){var self=this;definition=definition||{},this.schema=schema,this.name=name,this.type=Model.Schema.Types.Any,this["default"]=definition["default"],this["null"]=utils.is("Boolean",definition["null"])?definition["null"]:!0;var type=definition.type||definition;utils.is("String",type)&&(type=Model.Schema.Types[type]),type instanceof Model.Schema.Type?type.match("Self")?(this.type=new Model.Schema.Type(type.name,this.schema.Constructor),this.type.original=type):this.type=type:utils.forEach(Model.Schema.Types,function(propType){return propType["native"]&&propType.match(type)?(self.type=propType,!1):propType.match(Model.Schema.Types.Model)&&utils.inherits("Model",type)||propType.match(Model.Schema.Types.Collection)&&utils.inherits("Collection",type)?(self.type=new Model.Schema.Type(propType.name,type),!1):void 0}),keyAttributes.forEach(function(attribute){utils.isDefined(definition[attribute])&&self.filter(attribute,definition[attribute])});var proto=schema.Constructor.prototype;utils.define.apply(proto,[name,{get:function(){return proto.get.apply(this,[name])},set:function(value){proto.set.apply(this,[name,value])}}])};Key.prototype.evaluate=function(value,model){var hasModel=utils.isDefined(model),current=hasModel?model.get(this.name):undefined,defined=utils.isDefined(current)&&null!==current,result=current;if(null===value){if(this["null"])return null;this["throw"]("`"+this.name+"` cannot be null",model)}switch(this.type.name){case Model.Schema.Types.Model.name:case Model.Schema.Types.Collection.name:case Model.Schema.Types.Self.name:value instanceof this.type.Constructor?result=value:defined?current.load(value):result=new this.type.Constructor(value);break;case Model.Schema.Types.Date.name:result=new this.type.Constructor(value||null);break;case Model.Schema.Types.Array.name:value=utils.is("Array",value)?value:utils.isDefined(value)?[value]:[],defined?(current.length=0,current.push.apply(current,value)):result=value;break;case Model.Schema.Types.Any.name:result=value;break;default:this.type.match(Model.Schema.Types.String)&&utils.is("Array",this["enum"])&&(this.isValidEnum(value)||this["throw"]("Invalid enum value: "+value,model)),result=utils.isDefined(value)?this.type.Constructor(value):this.type.Constructor()}return result},Key.prototype.hasDefault=function(){return utils.isDefined(this["default"])},Key.prototype.getDefault=function(model){return utils.isFunction(this["default"])?this["default"].apply(this,utils.isDefined(model)?[model]:[]):this["default"]},Key.prototype.isValidEnum=function(value){return this["enum"].indexOf(value)>=0},Key.prototype.filter=function(attribute,value){switch(attribute){case"enum":var items=utils.is("Array",value)?value:[value],enumerable=[];if(items.forEach(function(item){utils.is("String",item)&&item.length&&enumerable.push(item)}),this[attribute]=enumerable,this.hasDefault()){var defaultValue=this.getDefault();this.isValidEnum(defaultValue)||this["throw"]("Invalid enum default value: "+defaultValue)}}},Key.prototype["throw"]=function(message,model){Model.Exception.prototype["throw"].apply(model||this,[message])},Key.prototype["export"]=function(){var self=this,json={type:this.type.original||this.type};return this.hasDefault()&&(json["default"]=this["default"]),keyAttributes.forEach(function(attribute){utils.isDefined(self[attribute])&&(json[attribute]=self[attribute])}),json},Model.Schema.Key=Key}(window,window.Model,window.Model.utils);