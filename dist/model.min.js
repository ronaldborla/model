!function(window,undefined){"use strict";function Model(schema,define){function attr(self){return $(self).attributes}function construct(self,args){$(self).attributes={},$(self).listeners={};for(var l=self.schema.length,i=l;i--;)self.schema[l-i-1].hasDefault()&&(self[self.schema[l-i-1].name]=self.schema[l-i-1].getDefault(self));return self}function filterData(name,data){return data}function getAttribute(name){var mutator=this.constructor.$cache.mutators.get[name],orig=attr(this)[name];if(utils.isUndefined(mutator)){var fn=utils.camelCase(["get",name,"attribute"].join(" "));mutator=this.constructor.$cache.mutators.get[name]=utils.isFunction(this[fn])?fn:null}return null!==mutator?this[mutator].apply(this,[orig]):orig}function inherit(extendSchema,defineModel){var parentSchema=this.prototype.schema,childSchema=parentSchema["export"](extendSchema),methods={},options=utils.clone(parentSchema.options||{}),statics={},virtuals={};return utils.inherit(parentSchema.Constructor,function(construct){return defineModel(construct,methods,virtuals,statics,options)},function(proto,Constructor){return proto.schema=new Model.Schema(Constructor,childSchema,parentSchema,utils.keys(virtuals||{}),options),utils.extendConstructor(Constructor,methods,virtuals,statics)})}function loadData(data){var self=this;if(data=this.filter("load",data),utils.isDefined(data)){this.fire("beforeload",[data]);for(var l=this.schema.length,i=l;i--;)utils.isDefined(data[this.schema[l-i-1].name])&&(self[this.schema[l-i-1].name]=data[this.schema[l-i-1].name]);this.fire("load")}return this}function setAttribute(name,value){var key=this.schema.get(name),attributes=attr(this),previous=attributes[name],mutator=this.constructor.$cache.mutators.set[name],evaluated=key.evaluate(value,this);if(utils.isUndefined(mutator)){var fn=utils.camelCase(["set",name,"attribute"].join(" "));mutator=this.constructor.$cache.mutators.set[name]=utils.isFunction(this[fn])?fn:null}return null!==mutator?attributes[name]=this[mutator].apply(this,[evaluated,previous]):attributes[name]=evaluated,attributes[name]&&"object"==typeof attributes[name]&&(utils.$(attributes[name]).parent=this),this.fire("setAttribute",[name,attributes[name],previous]),this.fire(mutator,[attributes[name],previous]),utils.typeCompare(key.type,attributes[name],previous)&&this.change(),this}function toJson(exclude,replacer,space){return JSON.stringify(this.toObject(exclude),replacer,space)}function toObject(exclude){function registerValue(key){var keyName=key.name||key;if(exclude[keyName]!==!0){var exportMethod=utils.camelCase(["export",keyName,"attribute"].join(" ")),value=utils.isFunction(self[exportMethod])?self[exportMethod].apply(self,[self[keyName]]):self[keyName],hasToObject=value&&utils.isFunction(value.toObject);hasToObject||!utils.is("Object",value)||utils.is("Array",value)||(value=utils.is("Date",value)?value.toString():utils.cleanObject(value)),object[keyName]=hasToObject?value.toObject(exclude[keyName]):value}}var i=0,l=0,self=this,object={};for(utils.isDefined(exclude)?(utils.is("String",exclude)&&(exclude=[exclude]),utils.is("Array",exclude)&&(exclude=utils.arrayOfStringsToObject(exclude))):exclude={},utils.is("Object",exclude)||this["throw"]("`exclude` must be an object or an array of strings"),i=l=this.schema.length;i--;)registerValue(this.schema[l-i-1]);if(this.schema.options&&this.schema.options["export"]&&this.schema.options["export"].virtuals)for(i=l=this.schema.virtuals.length;i--;)registerValue(this.schema.virtuals[l-i-1]);return object=this.filter("export",object),this.fire("export",[object,exclude]),object}var $=Model.utils.$,Constructor=null,methods={},options={},statics={},utils=Model.utils,virtuals={};return methods.change=utils.change,methods.define=utils.define,methods.emit=utils.emit,methods.filter=filterData,methods.fire=utils.fire,methods.get=getAttribute,methods.load=loadData,methods.on=utils.on,methods.set=setAttribute,methods["throw"]=utils["throw"],methods.toJson=toJson,methods.toObject=toObject,statics.inherit=inherit,statics.isModel=!0,utils.isFunction(define)&&(Constructor=define(construct,methods,virtuals,statics,options)),utils.isFunction(Constructor)||(Constructor=function(data){construct(this).load(data)}),Constructor.prototype.schema=new Model.Schema(Constructor,schema,null,utils.keys(virtuals||{}),options),Constructor.prototype.$cache={mutators:{get:{},set:{}}},utils.extendConstructor(Constructor,methods,virtuals,statics)}window.Model=Model}(window),function(window,Model,undefined){"use strict";function arrayOfStringsToObject(strings){var i=0,l=0,object={};if(utils.is("Array",strings))for(i=l=strings.length;i--;){var arr=strings[l-i-1].split("."),name=arr[0],child=arr.length>1?arr.splice(1).join("."):"";utils.isUndefined(object[name])&&(object[name]=[]),child&&object[name]!==!0?object[name].push(child):object[name]=!0}var keys=utils.keys(object);for(i=l=keys.length;i--;)utils.is("Array",object[keys[l-i-1]])&&(object[keys[l-i-1]]=utils.arrayOfStringsToObject(object[keys[l-i-1]]));return object}function camelCase(str){return str.replace(/[-_]+/g," ").replace(/(?:^\w|[A-Z]|\b\w|[\s-_]+)/g,function(match,index){return 0===+match?"":0===index?match.toLowerCase():match.toUpperCase()})}function changeModel(){this.emit("change")}function cleanObject(dirty){for(var keys=window.Object.keys(dirty),l=keys.length,i=l,object={};i--;)keys[l-i-1]!==utils.sign&&(object[keys[l-i-1]]=dirty[keys[l-i-1]]);return object}function cloneObject(object){return JSON.parse(JSON.stringify(object))}function compareType(a,b,deep,level){var aType=utils.type(a),bType=utils.type(b);return aType.name!==bType.name||utils.typeCompare(aType,a,b,deep,level)}function defineProperty(name,definition){return window.Object.defineProperty(this,name,definition),this}function dollarSign(self){return utils.hasSign(self)||(self[utils.sign]={}),self[utils.sign]}function emitEvent(event,args){var parent=this,sourceStack=[this];utils.is("Array",args)||(args=[]);args.length;for(args.push(sourceStack);;){if(parent.fire(event,args),!utils.isDefined(utils.$(parent).parent)||!utils.isFunction(utils.$(parent).parent.fire))break;parent=utils.$(parent).parent,sourceStack.push(parent)}return this}function extendConstructor(Constructor,methods,virtuals,statics){var proto=Constructor.prototype;methods=methods||{},virtuals=virtuals||{},statics=statics||{},utils.extend(proto,methods);for(var keys=window.Object.keys(virtuals),l=keys.length,i=l;i--;)utils.define.apply(proto,[keys[l-i-1],{get:virtuals[keys[l-i-1]]}]);return utils.extend(Constructor,statics),Constructor}function extendObject(left,right){return utils.forEach(right,function(value,name){left[name]=value}),left}function fireEvent(event,args){var self=this,listeners=utils.events(this);if(utils.is("Array",listeners[event]))for(var l=listeners[event].length,i=l;i--;)listeners[event][l-i-1].apply(self,args||[]);return this}function forEachObject(object,callback){for(var o in object)if(object.hasOwnProperty(o)&&callback.apply(object,[object[o],o,object])===!1)return!1;return!0}function getKeys(object,sort){var keys=window.Object.keys(object);return"undefined"!=typeof sort&&utils.sort(keys,!sort),keys}function getListeners(self){return utils.isUndefined(utils.$(self).listeners)&&(utils.$(self).listeners={}),utils.$(self).listeners}function getType(value){for(var l=utils.typeOrder.length,i=l;i--;){var type=Model.Schema.Types[utils.typeOrder[l-i-1]];if(type.is(value))return type}return Model.Schema.Types.Any}function hasSign(self){return utils.isDefined(self[utils.sign])}function inheritConstructor(Parent,getConstructor,definePrototype){var construct=function(child,args){return Parent.apply(child,args||[]),child},Constructor=getConstructor(construct);return Constructor.prototype=window.Object.create(Parent.prototype),Constructor.prototype.constructor=Constructor,utils.extend(Constructor,Parent),utils.isFunction(definePrototype)&&definePrototype(Constructor.prototype,Constructor),Constructor}function inherits(type,Constructor){return type=type.name||type,Model.Schema.Types[type]&&Model.Schema.Types[type].inherits(Constructor)}function isDefined(variable){return variable!==undefined}function isFunction(object){return!!(object&&object.constructor&&object.call&&object.apply)}function isType(type,value){return type=type.name||type,Model.Schema.Types[type]&&Model.Schema.Types[type].is(value)}function isUndefined(variable){return variable===undefined}function onEvent(event,callback){var listeners=utils.events(this);return utils.is("Array",listeners[event])||(listeners[event]=[],listeners[event].count=0),utils.isFunction(callback)&&(callback.index=listeners[event].count,listeners[event].push(callback),listeners[event].count++),function(){for(var l=listeners[event].length,i=l;i--;)if(listeners[event][l-i-1].index===callback.index){listeners[event].splice(l-i-1,1);break}}}function sortArray(array,descending){return array.sort(function(a,b){return descending?b-a:a-b}),array}function throwException(message){Model.Exception.prototype["throw"].apply(this,[message])}function typeCompare(type,a,b,deep,level){return!type.is(a)||!type.is(b)||type.compare(a,b,deep,level)}function ucfirst(string){return string[0].toUpperCase()+string.substr(1)}var utils={};Model.utils=utils,utils.sign="__local__",utils.typeOrder=["Boolean","Number","String","Date","Array","Model","Collection","Object"],utils.$=dollarSign,utils.arrayOfStringsToObject=arrayOfStringsToObject,utils.camelCase=camelCase,utils.change=changeModel,utils.cleanObject=cleanObject,utils.clone=cloneObject,utils.compare=compareType,utils.define=defineProperty,utils.emit=emitEvent,utils.events=getListeners,utils.extend=extendObject,utils.extendConstructor=extendConstructor,utils.fire=fireEvent,utils.forEach=forEachObject,utils.hasSign=hasSign,utils.inherit=inheritConstructor,utils.inherits=inherits,utils.is=isType,utils.isDefined=isDefined,utils.isFunction=isFunction,utils.isUndefined=isUndefined,utils.keys=getKeys,utils.on=onEvent,utils.sort=sortArray,utils["throw"]=throwException,utils.type=getType,utils.typeCompare=typeCompare,utils.ucfirst=ucfirst}(window,window.Model),function(window,Model,utils,undefined){"use strict";function Collection(ModelConstructor,define){function apply(method,array,args){return Arr[method].apply(array,args||[])}function call(method,array,args){return Arr[method].call(array,args||[])}function construct(self){return $(self).listeners={},self}utils.inherits("Model",ModelConstructor)||utils["throw"]("Constructor must inherit the Model constructor");var Constructor=null,methods={},virtuals={},statics={},Arr=window.Array.prototype,$=utils.$;return methods.define=utils.define,methods.on=utils.on,methods.fire=utils.fire,methods.emit=utils.emit,methods.change=utils.change,methods["throw"]=utils["throw"],statics.isCollection=!0,utils.isFunction(define)&&(Constructor=define(construct,methods,virtuals,statics)),utils.isFunction(Constructor)||(Constructor=function(data){construct(this).load(data)}),utils.inherit(window.Array,function(){return Constructor},function(proto,Collection){function convertItem(item){return item=this.filter("convert",item),item instanceof this.Model||(item=new this.Model(item)),utils.$(item).parent=this,item}function fillArray(){return utils.isDefined(arguments[0])&&(arguments[0]=this.convert(arguments[0])),apply("fill",this,arguments)}function filterData(name,data){return data}function loadItems(items){return this.length=0,this.push.apply(this,this.filter("load",items)),this}function pushItem(){var self=this;return apply("push",this,call("slice",arguments||{}).map(function(arg){return self.convert(arg)}))}function spliceArray(){var args=call("slice",arguments||{});if(args.length>2)for(var l=args.length,i=l-2;i--;)args[l-i-1]=this.convert(args[l-i-1]);return apply("splice",this,args)}function toJson(exclude,replacer,space){return JSON.stringify(this.toObject(exclude),replacer,space)}function toObject(exclude){return this.map(function(item){return item.toObject(exclude)})}function unshiftArray(){var self=this;return apply("unshift",this,call("slice",arguments||{}).map(function(arg){return self.convert(arg)}))}return proto.convert=convertItem,proto.load=loadItems,proto.fill=fillArray,proto.filter=filterData,proto.Model=ModelConstructor,proto.push=pushItem,proto.splice=spliceArray,proto.toJson=toJson,proto.toObject=toObject,proto.unshift=unshiftArray,utils.extendConstructor(Collection,methods,virtuals,statics)})}Model.Collection=Collection}(window,window.Model,window.Model.utils),function(window,Error,Model,utils,undefined){"use strict";function throwException(message){throw new Model.Exception(message,this)}Model.Exception=utils.inherit(Error,function(construct){function Exception(message,source){construct(this),this.message=message,this.source=source,this.stack=(new Error).stack}return Exception}),Model.Exception.prototype["throw"]=throwException}(window,window.Error,window.Model,window.Model.utils),function(window,Model,utils,undefined){"use strict";Model.Schema=utils.inherit(window.Array,function(construct){function Schema(Constructor,schema,parent,virtuals,options){var i=0,l=0;if(this.Constructor=Constructor,this.parent=parent||null,this.virtuals=virtuals||[],this.options=options||{},this.index={},this.parent)for(i=l=this.parent.virtuals.length;i--;)this.virtuals.indexOf(this.parent.virtuals[l-i-1])<0&&this.virtuals.push(this.parent.virtuals[l-i-1]);if(utils.isDefined(schema)){var keys=window.Object.keys(schema);for(i=l=keys.length;i--;)this.set(keys[l-i-1],schema[keys[l-i-1]])}}return Schema},function(proto,Schema){function exportSchema(extend){for(var json={},l=this.length,i=l;i--;)json[this[l-i-1].name]=this[l-i-1]["export"]();return utils.extend(json,extend||{})}function getKey(name){if(utils.isDefined(this.index[name]))return this[this.index[name]];for(var l=this.length,i=l;i--;)if(this[l-i-1].name===name){this.index[name]=l-i-1;break}return this[this.index[name]]}function setKey(name,definition){var key=new Schema.Key(this,name,definition);this.index[key.name]=this.length,this.push(key)}proto["export"]=exportSchema,proto.get=getKey,proto.set=setKey})}(window,window.Model,window.Model.utils),function(window,Model,utils,undefined){"use strict";function Type(name,Constructor,native){this.Constructor=Constructor||null,this.name=name,this["native"]=!!native,this.original=null,this.raw=(name||"").toLowerCase()}function compareType(a,b,deep,level){return a-b}function inherits(Constructor){return utils.isFunction(Constructor)&&this.Constructor===Constructor}function isType(value){if(null===value)return!1;var type=(typeof value||"").toLowerCase();return"object"===type&&value instanceof this.Constructor||this.raw===type}function matchConstructor(check){if(check instanceof(this.prototype||this).constructor)return this.match(check.name);var match="Constructor";return utils.is("String",check)&&(match="name"),this[match]===check}Model.Schema.Type=Type,Model.Schema.Types={},Type.prototype.compare=compareType,Type.prototype.inherits=inherits,Type.prototype.is=isType,Type.prototype.match=matchConstructor}(window,window.Model,window.Model.utils),function(window,Type,Types,utils){"use strict";function compareType(a,b,deep,level){return!1}function inherits(Constructor){return!1}function isType(value){return!0}Types.Any=new Type("Any"),Types.Any.compare=compareType,Types.Any.inherits=inherits,Types.Any.is=isType}(window,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types,utils){"use strict";function compareType(a,b,deep,level){if(a.length!==b.length)return!0;if(deep||!level)for(var l=a.length,i=l;i--;){var aItem=a[l-i-1],bItem=b[l-i-1];if(utils.compare(aItem,bItem,deep,(level||0)+1))return!0}return!1}function isType(value){return value&&(value.constructor===window.Array||value instanceof window.Array)}Types.Array=new Type("Array",window.Array,(!0)),Types.Array.compare=compareType,Types.Array.is=isType}(window,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types){"use strict";Types.Boolean=new Type("Boolean",window.Boolean,(!0))}(window,window.Model.Schema.Type,window.Model.Schema.Types),function(window,Collection,Type,Types,utils){"use strict";function compareType(a,b,deep,level){if(a.constructor!==b.constructor)return!0;if(deep||!level)for(var l=a.length,i=l;i--;)if(utils.typeCompare(Types.Model,a[l-i-1],b[l-i-1],deep,(level||0)+1))return!0;return!1}function inherits(Constructor){return utils.isFunction(Constructor)&&!!Constructor.isCollection}function isType(value){return value&&value.prototype&&value.prototype.constructor&&value.prototype.constructor.isCollection}Types.Collection=new Type("Collection"),Types.Collection.compare=compareType,Types.Collection.inherits=inherits,Types.Collection.is=isType}(window,window.Model.Collection,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types){"use strict";function isType(value){return value&&(value.constructor===window.Date||value instanceof window.Date)}Types.Date=new Type("Date",window.Date,(!0)),Types.Date.is=isType}(window,window.Model.Schema.Type,window.Model.Schema.Types),function(window,Model,Type,Types,utils){"use strict";function compareType(a,b,deep,level){if(a.constructor!==b.constructor)return!0;if(deep||!level)for(var l=a.schema.length,i=l;i--;){var key=a.schema[l-i-1];if(utils.typeCompare(key.type,a[key.name],b[key.name],deep,(level||0)+1))return!0}return!1}function inherits(Constructor){return utils.isFunction(Constructor)&&!!Constructor.isModel}function isType(value){return!!(value&&value.prototype&&value.prototype.constructor&&value.prototype.constructor.isModel)}Types.Model=new Type("Model"),Types.Model.compare=compareType,Types.Model.inherits=inherits,Types.Model.is=isType}(window,window.Model,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types){"use strict";Types.Number=new Type("Number",window.Number,(!0))}(window,window.Model.Schema.Type,window.Model.Schema.Types),function(window,Type,Types,utils){"use strict";function compareType(a,b,deep,level){var aKeys=utils.keys(a,!0),bKeys=utils.keys(b,!0),l=aKeys.length;if(l!==bKeys.length)return!0;if(deep||!level)for(var i=l;i--;){var aKey=aKeys[l-i-1],bKey=bKeys[l-i-1];if(aKey!==bKey)return!0;if(utils.compare(aKey,bKey,deep,(level||0)+1))return!0}return!1}Types.Object=new Type("Object",window.Object,(!0)),Types.Object.compare=compareType}(window,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types,utils){"use strict";function compareType(a,b,deep,level){return!1}function isType(value){return!1}Types.Self=new Type("Self"),Types.Self.compare=compareType,Types.Self.is=isType}(window,window.Model.Schema.Type,window.Model.Schema.Types,window.Model.utils),function(window,Type,Types){"use strict";function compareType(a,b,deep,level){return a<b?-1:a>b?1:0}Types.String=new Type("String",window.String,(!0)),Types.String.compare=compareType}(window,window.Model.Schema.Type,window.Model.Schema.Types),function(window,Model,utils,undefined){"use strict";function Key(schema,name,definition){definition=definition||{};var i=0,l=0,proto=schema.Constructor.prototype,type=definition.type||definition;if(this.schema=schema,this.name=name,this.type=Model.Schema.Types.Any,this["default"]=definition["default"],this["null"]=!utils.is("Boolean",definition["null"])||definition["null"],utils.is("String",type)&&(type=Model.Schema.Types[type]),type instanceof Model.Schema.Type)type.match("Self")?(this.type=new Model.Schema.Type(type.name,this.schema.Constructor),this.type.original=type):this.type=type;else for(i=l=typesKeys.length;i--;){var propType=Model.Schema.Types[typesKeys[l-i-1]];propType["native"]&&propType.match(type)?this.type=propType:(propType.match(Model.Schema.Types.Model)&&utils.inherits("Model",type)||propType.match(Model.Schema.Types.Collection)&&utils.inherits("Collection",type))&&(this.type=new Model.Schema.Type(propType.name,type))}for(i=l=keyAttributes.length;i--;)utils.isDefined(definition[keyAttributes[l-i-1]])&&this.filter(keyAttributes[l-i-1],definition[keyAttributes[l-i-1]]);utils.define.apply(proto,[name,{get:function(){return proto.get.apply(this,[name])},set:function(value){proto.set.apply(this,[name,value])}}])}function evaluateKey(value,model){var hasModel=utils.isDefined(model),current=hasModel?model.get(this.name):undefined,defined=utils.isDefined(current)&&null!==current,result=current;if(null===value){if(this["null"])return null;this["throw"]("`"+this.name+"` cannot be null",model)}switch(this.type.name){case Model.Schema.Types.Model.name:case Model.Schema.Types.Collection.name:case Model.Schema.Types.Self.name:value instanceof this.type.Constructor?result=value:defined?current.load(value):result=new this.type.Constructor(value);break;case Model.Schema.Types.Date.name:result=new this.type.Constructor(value||null);break;case Model.Schema.Types.Array.name:value=utils.is("Array",value)?value:utils.isDefined(value)?[value]:[],defined?(current.length=0,current.push.apply(current,value)):result=value;break;case Model.Schema.Types.Any.name:result=value;break;default:this.type.match(Model.Schema.Types.String)&&utils.is("Array",this["enum"])&&(this.isValidEnum(value)||this["throw"]("Invalid enum value: "+value,model)),result=utils.isDefined(value)?this.type.Constructor(value):this.type.Constructor()}return result}function exportKey(){var l=keyAttributes.length,i=l,self=this,json={type:this.type.original||this.type};for(this.hasDefault()&&(json["default"]=this["default"]);i--;)utils.isDefined(self[keyAttributes[l-i-1]])&&(json[keyAttributes[l-i-1]]=self[keyAttributes[l-i-1]]);return json}function filterDefinition(attribute,value){switch(attribute){case"enum":for(var items=utils.is("Array",value)?value:[value],enumerable=[],l=items.length,i=l;i--;)utils.is("String",items[l-i-1])&&items[l-i-1].length&&enumerable.push(items[l-i-1]);if(this[attribute]=enumerable,this.hasDefault()){var defaultValue=this.getDefault();this.isValidEnum(defaultValue)||this["throw"]("Invalid enum default value: "+defaultValue)}}}function getDefault(model){return utils.isFunction(this["default"])?this["default"].apply(this,utils.isDefined(model)?[model]:[]):this["default"]}function hasDefault(){return utils.isDefined(this["default"])}function isValidEnum(value){return this["enum"].indexOf(value)>=0}function throwException(message,model){Model.Exception.prototype["throw"].apply(model||this,[message])}var keyAttributes=["enum"],typesKeys=window.Object.keys(Model.Schema.Types);Model.Schema.Key=Key,Key.prototype.evaluate=evaluateKey,Key.prototype["export"]=exportKey,Key.prototype.filter=filterDefinition,Key.prototype.getDefault=getDefault,Key.prototype.hasDefault=hasDefault,Key.prototype.isValidEnum=isValidEnum,Key.prototype["throw"]=throwException}(window,window.Model,window.Model.utils);