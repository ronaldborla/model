window.Model=function(window,undefined){"use strict";var Model=function(schema,define){var Constructor=null,methods={},virtuals={},statics={},utils=Model.utils,$=utils.$,change=utils.change,attr=function(self){return $(self).attributes},compare=function(left,right){return!1},construct=function(self){return $(self).attributes={},$(self).listeners={},self.schema.forEach(function(key){utils.isDefined(key["default"])&&(self[key.name]=key["default"])}),self};methods.get=function(name){return attr(this)[name]},methods.set=function(name,value){var key=this.schema.get(name),attributes=attr(this),previous=attributes[name];return attributes[name]=key.evaluate(value,this),this.fire("setAttribute",[name,attributes[name]]),this.fire("set"+utils.ucfirst(name)+"Attribute",[attributes[name]]),compare(previous,attributes[name])||change(this),this},methods.define=utils.define,methods.on=utils.on,methods.fire=utils.fire,methods.emit=utils.emit,methods.broadcast=utils.broadcast,methods["throw"]=utils["throw"],methods.load=function(data){var self=this;return utils.isDefined(data)&&(this.schema.forEach(function(key){utils.isDefined(data[key.name])&&(self[key.name]=data[key.name])}),this.fire("load")),this},statics.isModel=!0,statics.inherit=function(getConstructor,definePrototype){},utils.isFunction(define)&&(Constructor=define(construct,methods,virtuals,statics)),utils.isFunction(Constructor)||(Constructor=function(data){construct(this).load(data)});var proto=Constructor.prototype;return utils.extend(proto,methods),proto.schema=new Model.Schema(Constructor,schema),utils.forEach(virtuals,function(method,name){methods.define.apply(proto,[name,{get:method}])}),utils.extend(Constructor,statics),Constructor};return Model}(window),function(window,Model,undefined){"use strict";var utils={};utils.isDefined=function(variable){return"undefined"!=typeof variable},utils.isFunction=function(object){return!!(object&&object.constructor&&object.call&&object.apply)},utils.isArray=function(object){return object&&object.constructor===Array},utils.isModel=function(Constructor){return utils.isFunction(Constructor)&&!!Constructor.isModel},utils.isType=function(value,type){return typeof value===type},utils.isNumber=function(value){return utils.isType(value,"number")},utils.isString=function(value){return utils.isType(value,"string")},utils.isCollection=function(Constructor){return utils.isFunction(Constructor)&&!!Constructor.isCollection},utils.forEach=function(object,callback){for(var o in object)if(object.hasOwnProperty(o)&&callback.apply(object,[object[o],o,object])===!1)return!1;return!0},utils.extend=function(left,right){return utils.forEach(right,function(value,name){left[name]=value}),left},utils.ucfirst=function(string){return string[0].toUpperCase()+string.substr(1).toLowerCase()},utils.inherit=function(Parent,getConstructor,definePrototype){var construct=function(child,args){return Parent.apply(child,args||[]),child},Constructor=getConstructor(construct);return Constructor.prototype=window.Object.create(Parent.prototype),Constructor.prototype.constructor=Constructor,utils.extend(Constructor,Parent),utils.isFunction(definePrototype)&&definePrototype(Constructor.prototype,Constructor),Constructor},utils.sign="__local__",utils.$=function(self){return utils.isDefined(self[utils.sign])||(self[utils.sign]={}),self[utils.sign]},utils.events=function(self){return utils.$(self).listeners},utils.change=function(self){self.emit("change")},utils.define=function(name,definition){return window.Object.defineProperty(this,name,definition),this},utils.on=function(event,callback){var listeners=utils.events(this);return utils.isArray(listeners[event])||(listeners[event]=[],listeners[event].count=0),utils.isFunction(callback)&&(callback.index=listeners[event].count,listeners[event].push(callback),listeners[event].count++),function(){for(var i=0;i<listeners[event].length;i++)if(listeners[event][i].index===callback.index){listeners[event].splice(i,1);break}}},utils.fire=function(event,args){var self=this,listeners=utils.events(this);return utils.isArray(listeners[event])&&listeners[event].forEach(function(listener){listener.apply(self,args||[])}),this},utils.emit=function(event,args){var parent=this,sourceStack=[this];utils.isArray(args)||(args=[]);args.length;for(args.push(sourceStack);;){if(parent.fire(event,[args]),!utils.isDefined(utils.$(parent).parent)||!utils.isFunction(utils.$(parent).parent.fire))break;parent=utils.$(parent).parent,sourceStack.push(parent)}return this},utils.broadcast=function(event,args){},utils["throw"]=function(message){Model.Exception.prototype["throw"].apply(this,[message])},Model.utils=utils}(window,window.Model),function(window,Model,utils,undefined){"use strict";var Exception=utils.inherit(window.Error,function(construct){return function(message,source){construct(this);this.message=message,this.source=source,this.stack=(new Error).stack}});Exception.prototype["throw"]=function(message){throw new Exception(message,this)},Model.Exception=Exception}(window,window.Model,window.Model.utils),function(window,Model,utils,undefined){"use strict";var Schema=utils.inherit(window.Array,function(construct){return function(Constructor,schema){var self=construct(this);this.Constructor=Constructor,utils.isDefined(schema)&&utils.forEach(schema,function(definition,name){self.set(name,definition)})}},function(proto,Schema){Schema.typeIsNative=function(type){return type.value<=5},proto.get=function(name){var index=-1;if(utils.isDefined(this.index)||(this.index={}),utils.isDefined(this.index[name])&&(index=this.index[name]),0>=index)for(var i=0;i<this.length;i++)if(this[i].name===name){this.index[name]=index=i;break}return this[index]},proto.set=function(name,definition){this.push(new Schema.Key(this,name,definition))}});Model.Schema=Schema}(window,window.Model,window.Model.utils),function(window,Model,utils,undefined){"use strict";var Type=function(name,value,Constructor){this.name=name,this.value=value,this.Constructor=Constructor};Type.prototype.is=function(check){if(check instanceof(this.prototype||this).constructor)return this.is(check.value);var match="Constructor";return utils.isNumber(check)?match="value":utils.isString(check)&&(match="name"),this[match]===check},Model.Schema.Type=Type,Model.Schema.Types={Boolean:new Type("Boolean",0,window.Boolean),Number:new Type("Number",1,window.Number),String:new Type("String",2,window.String),Date:new Type("Date",3,window.Date),Object:new Type("Object",4,window.Object),Array:new Type("Array",5,window.Array),Model:new Type("Model",6,Model),Collection:new Type("Collection",7,Model.Collection),Self:new Type("Self",8,null),Any:new Type("Any",9,null)}}(window,window.Model,window.Model.utils),function(window,Model,utils,undefined){"use strict";var Key=function(schema,name,definition){var self=this;definition=definition||{},this.schema=schema,this.name=name,this.type=Model.Schema.Types.Any,this["default"]=definition["default"];var type=definition.type||definition,attributes=["enum"];utils.isString(type)&&(type=Model.Schema.Types[type]),type instanceof Model.Schema.Type?type.is(Model.Schema.Types.Self)?this.type=new Model.Schema.Type(type.name,type.value,this.schema.Constructor):this.type=type:utils.forEach(Model.Schema.Types,function(propType){return Model.Schema.typeIsNative(propType)&&propType.is(type)?(self.type=propType,!1):propType.is(Model.Schema.Types.Model)&&utils.isModel(type)||propType.is(Model.Schema.Types.Collection)&&utils.isCollection(type)?(self.type=new Model.Schema.Type(propType.name,propType.value,type),!1):propType.is(Model.Schema.Types.Any)?!1:void 0}),attributes.forEach(function(attribute){utils.isDefined(definition[attribute])&&self.filter(attribute,definition[attribute])});var proto=schema.Constructor.prototype;proto.define.apply(proto,[name,{get:function(){return proto.get.apply(this,[name])},set:function(value){proto.set.apply(this,[name,value])}}])};Key.prototype.evaluate=function(value,model){var hasModel=utils.isDefined(model),current=hasModel?model.get(this.name):undefined,defined=utils.isDefined(current),result=current;switch(this.type.value){case Model.Schema.Types.Model.value:case Model.Schema.Types.Collection.value:case Model.Schema.Types.Self.value:defined?current.load(value):value instanceof this.type.Constructor?result=value:(result=new this.type.Constructor(value),hasModel&&(utils.$(result).parent=model));break;case Model.Schema.Types.Date.value:result=new this.type.Constructor(value||null);break;case Model.Schema.Types.Array.value:value=utils.isArray(value)?value:utils.isDefined(value)?[value]:[],defined?(current.length=0,current.push.apply(current,value)):result=value;break;case Model.Schema.Types.Any.value:result=value;break;default:this.type.is(Model.Schema.Types.String)&&utils.isArray(this["enum"])&&(this.isValidEnum(value)||this["throw"]("Invalid enum value: "+value,model)),result=utils.isDefined(value)?this.type.Constructor(value):this.type.Constructor()}return result},Key.prototype.hasDefault=function(){return utils.isDefined(this["default"])},Key.prototype.isValidEnum=function(value){return this["enum"].indexOf(value)>=0},Key.prototype.filter=function(attribute,value){switch(attribute){case"enum":var items=utils.isArray(value)?value:[value],enumerable=[];items.forEach(function(item){utils.isString(item)&&item.length&&enumerable.push(item)}),this[attribute]=enumerable,this.hasDefault()&&!this.isValidEnum(this["default"])&&this["throw"]("Invalid enum default value: "+this["default"])}},Key.prototype["throw"]=function(message,model){Model.Exception.prototype["throw"].apply(model||this,[message])},Model.Schema.Key=Key}(window,window.Model,window.Model.utils),function(window,Model,utils,undefined){"use strict";var Collection=function(ModelConstructor,define){var Constructor=null,methods={},virtuals={},statics={},$=utils.$,construct=(utils.change,function(self){return $(self).listeners={},self});return methods.define=utils.define,methods.on=utils.on,methods.fire=utils.fire,methods.emit=utils.emit,methods.broadcast=utils.broadcast,methods["throw"]=utils["throw"],utils.isFunction(define)&&(Constructor=define(construct,methods,virtuals,statics)),utils.isFunction(Constructor)||(Constructor=function(data){construct(this).load(data)}),utils.inherit(window.Array,function(){return Constructor},function(proto,Collection){proto.load=function(items){console.log(this)},utils.extend(proto,methods),utils.forEach(virtuals,function(method,name){methods.define.apply(proto,[name,{get:method}])}),utils.extend(Collection,statics)})};Collection.isCollection=!0,Model.Collection=Collection}(window,window.Model,window.Model.utils);
//# sourceMappingURL=model.min.js.map