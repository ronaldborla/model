(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?factory(exports):typeof define==="function"&&define.amd?define(["exports"],factory):factory(global.window=global.window||{})})(this,function(exports){"use strict";function __extends(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}var Utils=function(){function Utils(){this.undefined=function(undefined){return undefined}()}Utils.prototype.camelCase=function(str){return str.replace(/[-_]+/g," ").replace(/(?:^\w|[A-Z]|\b\w|[\s-_]+)/g,function(match,index){if(+match===0){return""}return index===0?match.toLowerCase():match.toUpperCase()})};Utils.prototype.extend=function(left,right,ignore){var hasIgnore=this.isArray(ignore);this.forEach(right,function(value,name){if(!hasIgnore||ignore.indexOf(name)<0){left[name]=value}});return left};Utils.prototype.flatten=function(data){var _this=this;var flattened={__flattened:true};if(!this.isUndefined(data)){var keys_1=[];(data||[]).forEach(function(item){var pos=item.indexOf("."),left=pos>=0?item.substr(0,pos):item,right=pos>=0?item.substr(pos+1):"";if(right){if(_this.isUndefined(flattened[left])){flattened[left]=[]}if(flattened[left]!==true){if(keys_1.indexOf(left)<0){keys_1.push(left)}flattened[left].push(right)}}else{flattened[left]=true}});keys_1.forEach(function(key){if(flattened[key]!==true){flattened[key]=_this.flatten(flattened[key])}})}return flattened};Utils.prototype.forEach=function(object,callback){for(var o in object){if(object.hasOwnProperty(o)){if(callback.apply(object,[object[o],o,object])===false){return false}}}return true};Utils.prototype.getParent=function(constructor){return Object.getPrototypeOf(constructor.prototype).constructor};Utils.prototype.isArray=function(variable){return variable&&variable.constructor===Array};Utils.prototype.isFunction=function(variable){return!!(variable&&variable.constructor&&variable.call&&variable.apply)};Utils.prototype.isObject=function(variable){return typeof variable==="object"};Utils.prototype.isRegExp=function(variable){return variable instanceof RegExp};Utils.prototype.isString=function(variable){return typeof variable==="string"||variable instanceof String};Utils.prototype.isUndefined=function(variable){return variable===this.undefined};return Utils}();var utils=new Utils;var Collection=function(){function Collection(items){this.__={parent:null};if(!utils.isUndefined(items)){this.load(items)}}Collection.prototype.cast=function(item){return item};Collection.prototype.load=function(items){return this};Collection.prototype.toObject=function(include,exclude){return{}};Collection.prototype.toJSON=function(exclude,include,replacer,space){return""};Collection.isCollection=true;return Collection}();Collection.prototype=Object.create(Array.prototype);Collection.prototype.constructor=Collection;Collection.prototype.cast=cast;Collection.prototype.concat=concat;Collection.prototype.load=load;Collection.prototype.push=push;Collection.prototype.splice=splice;Collection.prototype.toJSON=toJSON;Collection.prototype.toObject=toObject;Collection.prototype.toString=toString;Collection.prototype.unshift=unshift;function cast(item){var Model=this.constructor.Model;if(!(item instanceof Model)){item=new Model(item)}item.__.parent=this;return item}function concat(){var length=arguments.length;for(var i=0;i<length;i++){this.push.apply(this,arguments[i])}return this}function load(items){this.push.apply(this,items||[]);return this}function push(){var _this=this;return Array.prototype.push.apply(this,Array.prototype.map.apply(arguments,[function(item){return _this.cast(item)}]))}function splice(){var length=arguments.length;if(length>2){for(var i=2;i<length;i++){arguments[i]=this.cast(arguments[i])}}return Array.prototype.splice.apply(this,arguments)}function toJSON(exclude,include,replacer,space){return JSON.stringify(this.toObject(exclude,include),replacer,space)}function toObject(include,exclude){if(include&&!include.__flattened){include=utils.flatten(include)}if(exclude&&!exclude.__flattened){exclude=utils.flatten(exclude)}return this.map(function(item){return item.toObject(include,exclude)})}function toString(){return this.toJSON()}function unshift(){var length=arguments.length;for(var i=0;i<length;i++){arguments[i]=this.cast(arguments[i])}return Array.prototype.unshift.apply(this,arguments)}var Exception=function(_super){__extends(Exception,_super);function Exception(){return _super!==null&&_super.apply(this,arguments)||this}return Exception}(Error);var Model=function(){function Model(data){var _this=this;this.__={attributes:{},parent:null};this.constructor.schema.keys.forEach(function(key){if(data&&!utils.isUndefined(data[key.name])){_this[key.name]=data[key.name]}else if(utils.isFunction(key["default"])){_this[key.name]=key["default"]()}else if(!utils.isUndefined(key["default"])){_this[key.name]=key["default"]}})}Model.prototype.load=function(data){var _this=this;var schema=this.constructor.schema;if(!utils.isUndefined(data)){utils.forEach(data,function(value,key){if(!utils.isUndefined(value)&&!utils.isUndefined(schema.cache.index.keys[key])){_this[key]=value}})}return this};Model.prototype["super"]=function(method,args){return utils.getParent(this.constructor).prototype[method].apply(this,args||[])};Model.prototype.toJSON=function(exclude,include,replacer,space){return this.toObject(exclude,include)};Model.prototype.toObject=function(include,exclude){var _this=this;var object={};if(include&&!include.__flattened){include=utils.flatten(include)}if(exclude&&!exclude.__flattened){exclude=utils.flatten(exclude)}this.constructor.schema.keys.forEach(function(key){if(key.name!=="__"&&(!exclude||exclude[key.name]!==true)){evaluate(key.name,_this[key.name])}});if(include){utils.forEach(include,function(children,key){evaluate(key,_this[key])})}return object;function evaluate(key,value){if(value&&utils.isFunction(value.toObject)){value=value.toObject(include&&typeof include[key]!=="boolean"?include[key]:utils.undefined,exclude&&typeof exclude[key]!=="boolean"?exclude[key]:utils.undefined)}if(!utils.isUndefined(value)){object[key]=value}}};Model.prototype.toString=function(){return this.toJSON()};Model.Collection="Collection";Model.schema={};Model.isModel=true;return Model}();var Key=function(){function Key(schema,name,object){var key=this;this["default"]=object["default"];this.name=name;this.options=object.options;this.schema=schema;var type=object.type||object;if(utils.isString(type)){type=this.schema.modeljs.types[type]}if(utils.isUndefined(type)){throw new this.schema.modeljs.Exception("Type for key `"+name+"` is not registered")}this.type=new this.schema.modeljs.Type(this,type);Object.defineProperty(this.schema.Model.prototype,this.name,{enumerable:true,get:function getAttribute(){return callMutator.apply(this,["get",this.__.attributes[key.name]])},set:function setAttribute(value){var previous=this.__.attributes[key.name],options=key.options||utils.undefined;if(!utils.isUndefined(options)){options.parent=this}value=setParent(key.type.cast(value,options),this);this.__.attributes[key.name]=value=callMutator.apply(this,["set",value,previous])}});function callMutator(method,value,previous){var mutator=key.schema.cache.mutators[method][key.name];if(utils.isUndefined(mutator)){var fn=utils.camelCase([method,name,"attribute"].join(" "));mutator=key.schema.cache.mutators[method][name]=utils.isFunction(this[fn])?fn:null}if(mutator!==null){value=this[mutator].apply(this,[value,previous])}return value}function setParent(value,parent){if(value&&(value instanceof Model||value instanceof Collection)){value.__.parent=parent}return value}}return Key}();var Schema=function(){function Schema(modeljs,model){var _this=this;this.keys=[];this.cache={index:{keys:{}},mutators:{get:{},set:{}}};var constructors=[],schema={};this.modeljs=modeljs;this.Model=model;if(utils.isUndefined(this.modeljs.types[this.Model.Collection])){throw new this.modeljs.Exception("Collection `"+this.Model.Collection+"` is not registered")}this.Model.Collection=this.modeljs.types[this.Model.Collection];this.Model.Collection.Model=this.Model;while(model!==Model){constructors.push(model);model=utils.getParent(model)}for(var i=constructors.length-1;i>=0;i--){utils.extend(schema,constructors[i].schema)}var index=0;utils.forEach(schema,function(value,name){var key=new _this.modeljs.Key(_this,name,value);_this.cache.index.keys[name]=index++;_this.keys.push(key)})}return Schema}();var Type=function(){function Type(key,Constructor){this.key=key;if(!utils.isFunction(Constructor)){throw new this.key.schema.modeljs.Error("Type must be a constructor")}this.Constructor=Constructor;this.hasCompare=utils.isFunction(this.Constructor.prototype.compare);this.name=this.Constructor.name;this.safe=this.name.toLowerCase()}Type.prototype.cast=function(value,options){if(value===null){return value}if(!this.is(value)){value=utils.isUndefined(options)?new this.Constructor(value):new this.Constructor(value,options)}return value};Type.prototype.compare=function(a,b){if(this.hasCompare){return a.compare(b)}if(a>b){return 1}if(b>a){return-1}return 0};Type.prototype.is=function(value){return value&&(value instanceof this.Constructor||value.constructor.name===this.Constructor.name||(typeof value).toLowerCase()===this.safe)};return Type}();var ModelJS=function(){function ModelJS(){this.Exception=Exception;this.Key=Key;this.Schema=Schema;this.Type=Type;this.types={};this.schemas=[]}ModelJS.prototype.boot=function(){var _this=this;Object.keys(this.types).forEach(function(key){if(_this.types[key].isModel===true){_this.schemas.push(new _this.Schema(_this,_this.types[key]))}});this.schemas.forEach(function(schema){schema.Model.schema=schema});return this};ModelJS.prototype.getCollections=function(){var _this=this;return Object.keys(this.types).filter(function(key){return _this.types[key].isCollection===true}).map(function(key){return _this.types[key]})};ModelJS.prototype.getModels=function(){var _this=this;return Object.keys(this.types).filter(function(key){return _this.types[key].isModel===true}).map(function(key){return _this.types[key]})};ModelJS.prototype.register=function(types){var _this=this;if(!utils.isArray(types)){types=[types]}types.forEach(function(type){_this.types[type.name]=type});return this};return ModelJS}();exports.Collection=Collection;exports.Exception=Exception;exports.Key=Key;exports.Model=Model;exports.Schema=Schema;exports.Type=Type;exports.Utils=Utils;exports.utils=utils;exports.ModelJS=ModelJS;Object.defineProperty(exports,"__esModule",{value:true})});